build:
  box: golang
  steps:
    - setup-go-workspace

    # Install deps
    - almogbaku/dep-ensure

    # Tests
    - script:
      name: go test
      code: go test ./...
    - almogbaku/golint:
      exclude: "vendor"
    - almogbaku/gofmt-check

    # Build the project
    - script:
        name: go build
        code: |
          CGO_ENABLED=0 GOOS=linux go build -ldflags "-s -w -X main.Version=$WERCKER_GIT_COMMIT -X main.BuildDate=$(date -u '+%Y-%m-%d_%I:%M:%S%p')" -a -installsuffix nocgo -o nsqd-discovery .

    - script:
        name:
        code: |
            cp nsqd-discovery "$WERCKER_OUTPUT_DIR"


deploy:
    box: golang
    steps:
         # Use the scratch step to build a container from scratch based on the files present
        - internal/docker-scratch-push:
            username: _json_key
            password: $GCR_JSON_KEY_FILE
            repository: gcr.io/$GCE_PROJECT_ID/$WERCKER_GIT_REPOSITORY
            registry: https://gcr.io/v2
            entrypoint: ./nsqd-discovery
            tag: $WERCKER_GIT_COMMIT, latest
            user: "2016"

    after-steps:
      - slack-notifier:
          url: $SLACK_URL
          channel: r_n_d
          username: werckerbot